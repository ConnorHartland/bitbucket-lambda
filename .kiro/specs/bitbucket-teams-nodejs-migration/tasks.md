# Implementation Plan: Bitbucket Teams Webhook - Node.js Migration

## Overview

This implementation plan outlines the migration of the Bitbucket Teams webhook Lambda function from Python to Node.js. The system receives Bitbucket webhook events, validates signatures, detects failure events, formats them into rich Teams messages, and posts them to Microsoft Teams. The implementation follows a modular architecture with comprehensive error handling and logging.

## Tasks

- [x] 1. Set up project structure and core configuration
  - [x] 1.1 Initialize Node.js project with TypeScript configuration
    - _Requirements: 3.1, 3.2, 3.3_
  - [x] 1.2 Create Configuration class to load environment variables
    - _Requirements: 3.1, 3.2, 3.3_
  - [x] 1.3 Implement FilterConfig for event filtering
    - _Requirements: 5.5, 5.6_

- [x] 2. Implement webhook reception and signature verification
  - [x] 2.1 Create webhook reception module to extract headers and body
    - _Requirements: 1.1, 1.2, 1.3, 1.4_
  - [x] 2.2 Implement signature verification with HMAC-SHA256
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  - [x] 2.3 Add constant-time comparison for timing attack prevention
    - _Requirements: 2.6_
  - [x] 2.4 Implement minified JSON fallback for signature verification
    - _Requirements: 2.5_

- [x] 3. Implement AWS Secrets Manager integration
  - [x] 3.1 Create secrets retrieval module with caching
    - _Requirements: 4.1, 4.2, 4.3_
  - [x] 3.2 Implement secret caching for warm Lambda invocations
    - _Requirements: 4.3_
  - [x] 3.3 Add error handling for AWS service failures
    - _Requirements: 8.4_

- [x] 4. Implement IP restriction validation
  - [x] 4.1 Create IP restriction module for Bitbucket IP validation
    - _Requirements: 1.1_
  - [x] 4.2 Implement CIDR range matching with ipaddr.js
    - _Requirements: 1.1_
  - [x] 4.3 Add IP range caching with TTL
    - _Requirements: 1.1_

- [x] 5. Implement event parsing and failure detection
  - [x] 5.1 Create event parser for pull request events
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_
  - [x] 5.2 Implement commit status event parsing
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_
  - [x] 5.3 Implement push event parsing
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_
  - [x] 5.4 Implement comment event parsing
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_
  - [x] 5.5 Add failure detection logic for declined PRs, failed builds, and failed deployments
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 6. Implement Teams message formatting
  - [x] 6.1 Create Teams formatter module for Adaptive Card data
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8_
  - [x] 6.2 Implement color mapping for event types and actions
    - _Requirements: 7.4_
  - [x] 6.3 Implement mention entity creation for author emails
    - _Requirements: 7.5_
  - [x] 6.4 Add event-specific formatting for PR, push, comment, and commit status events
    - _Requirements: 7.2, 7.3_

- [x] 7. Implement Teams API posting
  - [x] 7.1 Create Teams client module for webhook posting
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_
  - [x] 7.2 Implement 10-second timeout for Teams API requests
    - _Requirements: 8.5_
  - [x] 7.3 Add proper error handling for Teams API failures
    - _Requirements: 8.3_

- [x] 8. Implement error handling and logging
  - [x] 8.1 Create error handler module with typed error classes
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7_
  - [x] 8.2 Implement logging utilities with context and sanitization
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_
  - [x] 8.3 Add sensitive data sanitization for logs
    - _Requirements: 10.6_
  - [x] 8.4 Implement JSON parsing error handling
    - _Requirements: 9.1_
  - [x] 8.5 Implement signature verification error handling
    - _Requirements: 9.2_
  - [x] 8.6 Implement AWS service error handling
    - _Requirements: 9.4_
  - [x] 8.7 Implement Teams API error handling
    - _Requirements: 9.5_

- [x] 9. Implement metrics and monitoring
  - [x] 9.1 Create metrics module with EMF (Embedded Metric Format)
    - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6_
  - [x] 9.2 Implement event type metrics
    - _Requirements: 11.1_
  - [x] 9.3 Implement signature failure metrics
    - _Requirements: 11.2_
  - [x] 9.4 Implement Teams API failure metrics
    - _Requirements: 11.3_
  - [x] 9.5 Implement unsupported event metrics
    - _Requirements: 11.4_
  - [x] 9.6 Implement processing duration metrics
    - _Requirements: 11.5, 11.6_

- [x] 10. Implement Lambda handler orchestration
  - [x] 10.1 Create main Lambda handler function
    - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7, 12.8, 12.9, 12.10_
  - [x] 10.2 Implement configuration loading on module initialization
    - _Requirements: 12.3, 12.4, 12.5_
  - [x] 10.3 Implement fail-fast for missing configuration
    - _Requirements: 12.4, 12.5_
  - [x] 10.4 Implement processing duration tracking
    - _Requirements: 12.6_
  - [x] 10.5 Implement request ID extraction and context propagation
    - _Requirements: 12.7, 12.8_

- [x] 11. Write unit tests for all modules
  - [x] 11.1 Write unit tests for configuration module
    - _Requirements: 3.1, 3.2, 3.3_
  - [x] 11.2 Write unit tests for signature verification
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  - [x] 11.3 Write unit tests for webhook reception
    - _Requirements: 1.1, 1.2, 1.3, 1.4_
  - [x] 11.4 Write unit tests for event parsing
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_
  - [x] 11.5 Write unit tests for Teams formatting
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8_
  - [x] 11.6 Write unit tests for Teams client
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_
  - [x] 11.7 Write unit tests for error handling
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7_
  - [x] 11.8 Write unit tests for logging utilities
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_
  - [x] 11.9 Write unit tests for metrics
    - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6_
  - [x] 11.10 Write unit tests for IP restriction
    - _Requirements: 1.1_

- [x] 12. Write property-based tests for correctness properties
  - [x] 12.1 Write property test for webhook reception field extraction
    - **Property 1: Webhook Reception Extracts Required Fields**
    - **Validates: Requirements 1.1, 1.2, 1.3**
  - [x] 12.2 Write property test for base64 decoding round trip
    - **Property 2: Base64 Decoding Round Trip**
    - **Validates: Requirements 1.4**
  - [x] 12.3 Write property test for invalid JSON handling
    - **Property 3: Invalid JSON Returns 200**
    - **Validates: Requirements 1.5**
  - [x] 12.4 Write property test for invalid signature handling
    - **Property 4: Invalid Signature Returns 200**
    - **Validates: Requirements 1.6**
  - [x] 12.5 Write property test for HMAC-SHA256 computation
    - **Property 5: HMAC-SHA256 Signature Computation**
    - **Validates: Requirements 2.1, 2.2**
  - [x] 12.6 Write property test for signature verification with minified JSON
    - **Property 6: Signature Verification with Minified JSON**
    - **Validates: Requirements 2.5**
  - [x] 12.7 Write property test for configuration loading
    - **Property 7: Configuration Loading from Environment**
    - **Validates: Requirements 3.1, 3.2**
  - [x] 12.8 Write property test for configuration validation
    - **Property 8: Configuration Validation Fails Fast**
    - **Validates: Requirements 3.3**
  - [x] 12.9 Write property test for secret retrieval
    - **Property 9: Secret Retrieval from AWS**
    - **Validates: Requirements 4.1, 4.2**
  - [x] 12.10 Write property test for secret caching
    - **Property 10: Secret Caching for Warm Invocations**
    - **Validates: Requirements 4.3**
  - [x] 12.11 Write property test for PR declined detection
    - **Property 11: PR Declined Detected as Failure**
    - **Validates: Requirements 5.1**
  - [x] 12.12 Write property test for commit status failed detection
    - **Property 12: Commit Status Failed Detected as Failure**
    - **Validates: Requirements 5.2**
  - [x] 12.13 Write property test for non-failure event handling
    - **Property 13: Non-Failure Events Ignored**
    - **Validates: Requirements 5.4**
  - [x] 12.14 Write property test for failure details extraction
    - **Property 14: Failure Details Extracted**
    - **Validates: Requirements 5.5**
  - [x] 12.15 Write property test for failure message formatting
    - **Property 15: Failure Message Includes Required Fields**
    - **Validates: Requirements 6.1**
  - [x] 12.16 Write property test for PR declined message formatting
    - **Property 16: PR Declined Message Formatting**
    - **Validates: Requirements 6.2**
  - [x] 12.17 Write property test for commit status message formatting
    - **Property 17: Commit Status Message Formatting**
    - **Validates: Requirements 6.3**
  - [x] 12.18 Write property test for red color assignment
    - **Property 18: Failure Messages Use Red Color**
    - **Validates: Requirements 6.4**
  - [x] 12.19 Write property test for mention entity creation
    - **Property 19: Mention Entity Creation**
    - **Validates: Requirements 6.5**
  - [x] 12.20 Write property test for failure link inclusion
    - **Property 20: Failure Link Included**
    - **Validates: Requirements 6.6**
  - [x] 12.21 Write property test for Teams posting success
    - **Property 21: Teams Posting Success**
    - **Validates: Requirements 7.1, 7.2**
  - [x] 12.22 Write property test for Teams posting failure logging
    - **Property 22: Teams Posting Failure Logged**
    - **Validates: Requirements 7.3**
  - [x] 12.23 Write property test for Teams posting headers
    - **Property 23: Teams Posting Headers**
    - **Validates: Requirements 7.4**
  - [x] 12.24 Write property test for Teams posting timeout
    - **Property 24: Teams Posting Timeout**
    - **Validates: Requirements 7.5**
  - [x] 12.25 Write property test for JSON error logging
    - **Property 25: JSON Error Logged**
    - **Validates: Requirements 8.1**
  - [x] 12.26 Write property test for signature error logging
    - **Property 26: Signature Error Logged**
    - **Validates: Requirements 8.2**
  - [x] 12.27 Write property test for configuration error handling
    - **Property 27: Configuration Error Fails Fast**
    - **Validates: Requirements 8.3**
  - [x] 12.28 Write property test for AWS error logging
    - **Property 28: AWS Error Logged**
    - **Validates: Requirements 8.4**
  - [x] 12.29 Write property test for Teams API error logging
    - **Property 29: Teams API Error Logged**
    - **Validates: Requirements 8.5**
  - [x] 12.30 Write property test for log sanitization
    - **Property 30: Log Sanitization**
    - **Validates: Requirements 10.6**
  - [x] 12.31 Write property test for handler signature
    - **Property 31: Handler Signature**
    - **Validates: Requirements 12.1, 12.2**
  - [x] 12.32 Write property test for configuration initialization
    - **Property 32: Configuration Loading on Initialization**
    - **Validates: Requirements 12.3**
  - [x] 12.33 Write property test for fail-fast on missing configuration
    - **Property 33: Fail Fast on Missing Configuration**
    - **Validates: Requirements 12.4, 12.5**
  - [x] 12.34 Write property test for processing duration logging
    - **Property 34: Processing Duration Logged**
    - **Validates: Requirements 12.6**
  - [x] 12.35 Write property test for success response
    - **Property 35: Success Response**
    - **Validates: Requirements 12.7, 12.8**

- [x] 13. Write integration tests
  - [x] 13.1 Write end-to-end integration test for complete webhook processing pipeline
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7, 12.8, 12.9, 12.10_

- [x] 14. Verify all tests pass
  - [x] 14.1 Run full test suite and verify all tests pass
    - _Requirements: All_
  - [x] 14.2 Verify code coverage meets requirements
    - _Requirements: All_

## Notes

- All tasks have been completed and the implementation is fully functional
- The system successfully processes Bitbucket webhooks with proper signature verification
- All error conditions are handled gracefully with appropriate logging
- Metrics are emitted for monitoring and debugging
- The codebase includes comprehensive unit tests and property-based tests
- All requirements from the design and requirements documents have been implemented
