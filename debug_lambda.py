#!/usr/bin/env python3
import json
import hmac
import hashlib

def debug_signature_verification():
    """Debug function to test signature verification with the exact data from Bitbucket"""
    
    # The secret from AWS Secrets Manager
    secret = "YW1LdytIMeoMPAkf"
    
    # The signature from the latest Bitbucket request
    received_signature = "0c92d89515904734a0bd1d85054173b15fbb810eefff8f743341fc97bc211508"
    
    # Test with different payload formats
    payloads_to_test = [
        # Original formatted payload (from Bitbucket webhook body display)
        '''{   "push": {     "changes": [       {         "old": {           "name": "feature/abc",           "target": {             "type": "commit",             "hash": "1868b4d3d8670ea7ef41120d091e966b765db619",             "date": "2025-12-10T07:14:55+00:00",             "author": {               "type": "author",               "raw": "Connor <connorhartland@gmail.com>",               "user": {                 "display_name": "Connor Hartland",                 "links": {                   "self": {                     "href": "https://api.bitbucket.org/2.0/users/%7Ba38fcee3-f61f-4698-a4b8-dd31299e89e0%7D"                   },                   "avatar": {                     "href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5e8d4b64acb63e0b83421034/6643f502-b2e5-4b34-aa9c-181011b710b2/128"                   },                   "html": {                     "href": "https://bitbucket.org/%7Ba38fcee3-f61f-4698-a4b8-dd31299e89e0%7D/"                   }                 },                 "type": "user",                 "uuid": "{a38fcee3-f61f-4698-a4b8-dd31299e89e0}",                 "account_id": "5e8d4b64acb63e0b83421034",                 "nickname": "Connor Hartland"               }             },             "committer": {},             "message": "testing\\n",             "summary": {               "type": "rendered",               "raw": "testing\\n",               "markup": "markdown",               "html": "<p>testing</p>"             },             "links": {               "self": {                 "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commit/1868b4d3d8670ea7ef41120d091e966b765db619"               },               "html": {                 "href": "https://bitbucket.org/connor-cicd/service-1/commits/1868b4d3d8670ea7ef41120d091e966b765db619"               }             },             "parents": [               {                 "hash": "95181a733cd793c902ec06798673ed5badcf0636",                 "links": {                   "self": {                     "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commit/95181a733cd793c902ec06798673ed5badcf0636"                   },                   "html": {                     "href": "https://bitbucket.org/connor-cicd/service-1/commits/95181a733cd793c902ec06798673ed5badcf0636"                   }                 },                 "type": "commit"               }             ],             "rendered": {},             "properties": {}           },           "links": {             "self": {               "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/refs/branches/feature/abc"             },             "commits": {               "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commits/feature/abc"             },             "html": {               "href": "https://bitbucket.org/connor-cicd/service-1/branch/feature/abc"             },             "pullrequest_create": {               "href": "https://bitbucket.org/connor-cicd/service-1/pull-requests/new?source=feature/abc&t=1"             }           },           "type": "branch",           "merge_strategies": [             "merge_commit",             "squash",             "fast_forward",             "squash_fast_forward",             "rebase_fast_forward",             "rebase_merge"           ],           "sync_strategies": [             "merge_commit",             "rebase"           ],           "default_merge_strategy": "merge_commit"         },         "new": {           "name": "feature/abc",           "target": {             "type": "commit",             "hash": "64140fa4f3f876bdb8c40c158a3310d894310ed7",             "date": "2025-12-10T07:19:26+00:00",             "author": {               "type": "author",               "raw": "Connor <connorhartland@gmail.com>",               "user": {                 "display_name": "Connor Hartland",                 "links": {                   "self": {                     "href": "https://api.bitbucket.org/2.0/users/%7Ba38fcee3-f61f-4698-a4b8-dd31299e89e0%7D"                   },                   "avatar": {                     "href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5e8d4b64acb63e0b83421034/6643f502-b2e5-4b34-aa9c-181011b710b2/128"                   },                   "html": {                     "href": "https://bitbucket.org/%7Ba38fcee3-f61f-4698-a4b8-dd31299e89e0%7D/"                   }                 },                 "type": "user",                 "uuid": "{a38fcee3-f61f-4698-a4b8-dd31299e89e0}",                 "account_id": "5e8d4b64acb63e0b83421034",                 "nickname": "Connor Hartland"               }             },             "committer": {},             "message": "v3\\n",             "summary": {               "type": "rendered",               "raw": "v3\\n",               "markup": "markdown",               "html": "<p>v3</p>"             },             "links": {               "self": {                 "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commit/64140fa4f3f876bdb8c40c158a3310d894310ed7"               },               "html": {                 "href": "https://bitbucket.org/connor-cicd/service-1/commits/64140fa4f3f876bdb8c40c158a3310d894310ed7"               }             },             "parents": [               {                 "hash": "1868b4d3d8670ea7ef41120d091e966b765db619",                 "links": {                   "self": {                     "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commit/1868b4d3d8670ea7ef41120d091e966b765db619"                   },                   "html": {                     "href": "https://bitbucket.org/connor-cicd/service-1/commits/1868b4d3d8670ea7ef41120d091e966b765db619"                   }                 },                 "type": "commit"               }             ],             "rendered": {},             "properties": {}           },           "links": {             "self": {               "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/refs/branches/feature/abc"             },             "commits": {               "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commits/feature/abc"             },             "html": {               "href": "https://bitbucket.org/connor-cicd/service-1/branch/feature/abc"             },             "pullrequest_create": {               "href": "https://bitbucket.org/connor-cicd/service-1/pull-requests/new?source=feature/abc&t=1"             }           },           "type": "branch",           "merge_strategies": [             "merge_commit",             "squash",             "fast_forward",             "squash_fast_forward",             "rebase_fast_forward",             "rebase_merge"           ],           "sync_strategies": [             "merge_commit",             "rebase"           ],           "default_merge_strategy": "merge_commit"         },         "truncated": false,         "created": false,         "forced": false,         "closed": false,         "links": {           "commits": {             "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commits?include=64140fa4f3f876bdb8c40c158a3310d894310ed7&exclude=1868b4d3d8670ea7ef41120d091e966b765db619"           },           "diff": {             "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/diff/64140fa4f3f876bdb8c40c158a3310d894310ed7..1868b4d3d8670ea7ef41120d091e966b765db619"           },           "html": {             "href": "https://bitbucket.org/connor-cicd/service-1/branches/compare/64140fa4f3f876bdb8c40c158a3310d894310ed7..1868b4d3d8670ea7ef41120d091e966b765db619"           }         },         "commits": [           {             "type": "commit",             "hash": "64140fa4f3f876bdb8c40c158a3310d894310ed7",             "date": "2025-12-10T07:19:26+00:00",             "author": {               "type": "author",               "raw": "Connor <connorhartland@gmail.com>",               "user": {                 "display_name": "Connor Hartland",                 "links": {                   "self": {                     "href": "https://api.bitbucket.org/2.0/users/%7Ba38fcee3-f61f-4698-a4b8-dd31299e89e0%7D"                   },                   "avatar": {                     "href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5e8d4b64acb63e0b83421034/6643f502-b2e5-4b34-aa9c-181011b710b2/128"                   },                   "html": {                     "href": "https://bitbucket.org/%7Ba38fcee3-f61f-4698-a4b8-dd31299e89e0%7D/"                   }                 },                 "type": "user",                 "uuid": "{a38fcee3-f61f-4698-a4b8-dd31299e89e0}",                 "account_id": "5e8d4b64acb63e0b83421034",                 "nickname": "Connor Hartland"               }             },             "committer": {},             "message": "v3\\n",             "summary": {               "type": "rendered",               "raw": "v3\\n",               "markup": "markdown",               "html": "<p>v3</p>"             },             "links": {               "self": {                 "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commit/64140fa4f3f876bdb8c40c158a3310d894310ed7"               },               "html": {                 "href": "https://bitbucket.org/connor-cicd/service-1/commits/64140fa4f3f876bdb8c40c158a3310d894310ed7"               },               "diff": {                 "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/diff/64140fa4f3f876bdb8c40c158a3310d894310ed7"               },               "approve": {                 "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commit/64140fa4f3f876bdb8c40c158a3310d894310ed7/approve"               },               "comments": {                 "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commit/64140fa4f3f876bdb8c40c158a3310d894310ed7/comments"               },               "statuses": {                 "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commit/64140fa4f3f876bdb8c40c158a3310d894310ed7/statuses"               },               "patch": {                 "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/patch/64140fa4f3f876bdb8c40c158a3310d894310ed7"               }             },             "parents": [               {                 "hash": "1868b4d3d8670ea7ef41120d091e966b765db619",                 "links": {                   "self": {                     "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1/commit/1868b4d3d8670ea7ef41120d091e966b765db619"                   },                   "html": {                     "href": "https://bitbucket.org/connor-cicd/service-1/commits/1868b4d3d8670ea7ef41120d091e966b765db619"                   }                 },                 "type": "commit"               }             ],             "rendered": {},             "properties": {}           }         ]       }     ]   },   "repository": {     "type": "repository",     "full_name": "connor-cicd/service-1",     "links": {       "self": {         "href": "https://api.bitbucket.org/2.0/repositories/connor-cicd/service-1"       },       "html": {         "href": "https://bitbucket.org/connor-cicd/service-1"       },       "avatar": {         "href": "https://bytebucket.org/ravatar/%7B3901e7f9-d4ac-4191-b065-4f235cd33e57%7D?ts=default"       }     },     "name": "service-1",     "scm": "git",     "website": null,     "owner": {       "display_name": "connor-cicd",       "links": {         "self": {           "href": "https://api.bitbucket.org/2.0/workspaces/%7Bffac8a42-ea64-40d6-ba3e-eb8b5ae5cd17%7D"         },         "avatar": {           "href": "https://bitbucket.org/account/connor-cicd/avatar/"         },         "html": {           "href": "https://bitbucket.org/%7Bffac8a42-ea64-40d6-ba3e-eb8b5ae5cd17%7D/"         }       },       "type": "team",       "uuid": "{ffac8a42-ea64-40d6-ba3e-eb8b5ae5cd17}",       "username": "connor-cicd"     },     "workspace": {       "type": "workspace",       "uuid": "{ffac8a42-ea64-40d6-ba3e-eb8b5ae5cd17}",       "name": "connor-cicd",       "slug": "connor-cicd",       "links": {         "avatar": {           "href": "https://bitbucket.org/workspaces/connor-cicd/avatar/?ts=1765077051"         },         "html": {           "href": "https://bitbucket.org/connor-cicd/"         },         "self": {           "href": "https://api.bitbucket.org/2.0/workspaces/connor-cicd"         }       }     },     "is_private": false,     "project": {       "type": "project",       "key": "MIC",       "uuid": "{71f1f6a1-6789-4b13-8c82-d14f15fefc66}",       "name": "microservices",       "links": {         "self": {           "href": "https://api.bitbucket.org/2.0/workspaces/connor-cicd/projects/MIC"         },         "html": {           "href": "https://bitbucket.org/connor-cicd/workspace/projects/MIC"         },         "avatar": {           "href": "https://bitbucket.org/connor-cicd/workspace/projects/MIC/avatar/32?ts=1765080577"         }       }     },     "uuid": "{3901e7f9-d4ac-4191-b065-4f235cd33e57}",     "parent": null   },   "actor": {     "display_name": "Connor Hartland",     "links": {       "self": {         "href": "https://api.bitbucket.org/2.0/users/%7Bb243013a-e876-4ec9-9be8-77cfe4a871a3%7D"       },       "avatar": {         "href": "https://secure.gravatar.com/avatar/72be9bbfaae39c1780e64607cc8e0b91?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FCH-5.png"       },       "html": {         "href": "https://bitbucket.org/%7Bb243013a-e876-4ec9-9be8-77cfe4a871a3%7D/"       }     },     "type": "user",     "uuid": "{b243013a-e876-4ec9-9be8-77cfe4a871a3}",     "account_id": "557058:b43446b2-dd23-4c6c-b9ce-c54d5f9ad7a2",     "nickname": "Connor Hartland"   } }'''
    ]
    
    def compute_signature(payload, secret):
        secret_bytes = secret.encode('utf-8')
        payload_bytes = payload.encode('utf-8')
        signature = hmac.new(secret_bytes, payload_bytes, hashlib.sha256)
        return signature.hexdigest()
    
    print(f"Target signature: {received_signature}")
    print(f"Secret: {secret}")
    print()
    
    for i, payload in enumerate(payloads_to_test):
        print(f"Testing payload {i+1}:")
        print(f"Length: {len(payload)} characters")
        
        # Test original payload
        computed = compute_signature(payload, secret)
        matches = computed == received_signature
        print(f"Original: {computed} -> {'‚úÖ MATCH!' if matches else '‚ùå'}")
        
        # Test minified version
        try:
            minified = json.dumps(json.loads(payload), separators=(',', ':'))
            computed_min = compute_signature(minified, secret)
            matches_min = computed_min == received_signature
            print(f"Minified: {computed_min} -> {'‚úÖ MATCH!' if matches_min else '‚ùå'}")
            print(f"Minified length: {len(minified)} characters")
        except Exception as e:
            print(f"Could not minify: {e}")
        
        print()
        
        if matches or matches_min:
            print("üéâ Found matching signature!")
            return True
    
    return False

if __name__ == "__main__":
    debug_signature_verification()